??? What is this ???
Is it still needed?

The first thing we are going to do is create wrappers to some of the MongoDB native driver's functions. Writing these functions, along with a small helper library and standardizing the way that data and errors are returned to the client will, make our code much more understandable and easier to maintain.

- About MongoDB queries
- Shaping data
- New project
- Install packages
- Create /db
- Create dbFunctions.js, helpers.js & index.js
- Import mongodb
- Store reference to MongoClient
- Connection details
- Connection management
- Returning errors
- Returning data
- Implementing `find()`
- Write tests



> TODO: what libs install, what they do and why. Maybe just links to save room and error?


> TODO: you missed test for dropCollection

# Start the project
```js
$ mkdir wrapping-calls-to-mongodb
$ cd wrapping-calls-to-mongodb
$ npm init -y
$ npm i mongodb @babel/runtime chalk ramda
$ npm i -D @babel/cli @babel/core @babel/node @babel/plugin-transform-runtime @babel/preset-env chai eslint eslint-plugin-import mocha nodemon supertest
```

## Project structure
```js
$ mkdir db
$ cd db
$ touch dbFunctions.js helpers.js index.js
cd ..
mkdir server
touch server/index.js
touch .babelrc .gitignore
```

## .gitignore
```js
dist
node_modules
coverage
logs
log
*.log
app.log.*
npm-debug.log*
pids
*.pid
*.seed
lib-cov
.lock-wscript
.npm
.node_repl_history
.nyc_output
```

## .babelrc
```js
{
  "presets": ["@babel/preset-env"],
  "plugins": [
    "@babel/plugin-transform-runtime",
  ]
}
```

## db/helpers.js
```js

```

## db/dbFunctions.js
All our calls to MongoDB will be done through functions in dbFunctions.js. Start by importing mongodb and getting a reference to the MongoClient.

```js
import mongodb from 'mongodb'

const MongoClient = mongodb.MongoClient
```

We will be hard-coding the database details for now. Later they will be moved to configuration
```js
const mongoUrl = 'mongodb://localhost:27017'
const dbName = 'todo-dev'
```

A reference to the client will be stored in the `client` variable and reused each time a call needs to be made. The `connectDB` function will make the connection to the client if it isn't already made, and then return a reference to the database.

> Todo: this is a little fuzzy. Read-up on what is actually happening here

```js
let client

async function connectDB() {
  if (!client) {
    client = await MongoClient.connect(mongoUrl, { useNewUrlParser: true })
    yellow('client.db', client.db(dbName))
  }
  return { db: client.db(dbName) }
}
```

`formatReturn` will be used after each call to MongoDB to standardize the way that messages are sent back to the client.
```js

export const formatReturn = (data=undefined, e=undefined) => {
  if (!data === undefined) {
    return { data: data, error: '' }
  }
  return { data: [], error: e.message }
}

```

The `find` function takes between 1 and 3 parameters

| Parameter | Type | Comment |
| --------- | ---- | ------- |
| `connection` | string | The collection name as a string. In our case 'todo-dev' |
| `filter` | object | A valid MongoDB query object. The default is `{}` which returns all documents in a collection.|
| `projection` | object | A valid MongoDB projection. The default is `{}` which will return all fields. |

- Queries are like filters. They limit the documents that are sent back
- In this case, the projection is a list of fields

The body of `find` is in a try/catch block so that formatReturn is called in the event of any type of error and the return value is in the correct shape.
```js
export const find = async (collection, filter = {}, project = {}) => {
  try {
    const { db } = await connectDB()
    const ret = await db.collection(collection).find(query).project(project).toArray()
    return { data: ret, meta: {} }
  }
  catch (e) {
    console.error('ERROR: dbFunctions.find', e.message)
    return formatReturn(e)
  }
}
```

## db/index.js
```js
import {
  find
} from './dbFunctions'

export {
  find
}
```

## server/index.js
```js
import { find } from './db'

async function findTest() {
  const todos = await find('todos')
  console.log('todos', todos)
}

findTest()
```

## Add start script in package.json
```js
"start": "babel-node server/index.js"
```

## Give it a try
```js
$ npm start
```


In the next section we will write some test for the `fined` function.
