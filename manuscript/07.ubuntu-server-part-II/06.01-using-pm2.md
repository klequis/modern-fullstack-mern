## Using PM2

PM2 is ...

PM2 will ...

## In Brief
Install
```console
// Install
$ sudo npm install pm2@latest -g

// Start
$ pm2 start app/server

// Startup
pm2 startup systemd

// Run command from output of last command
$ sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u doadmin --hp /home/doadmin

// Save process list and corresponding environments
$ pm2 save

// Start service with systemctl
$ sudo systemctl start pm2-doadmin

// Check status of systemmd unit
$ systemctl status pm2-doadmin
```

> TODO: The above are the steps. Not clear that they work. Need to try on new server and get info from PM2 documentation.

> TODO: Make decision of showing output. It is really really long.


## Installing PM2 globally


If your server is still running go back to the terminal where you started it and press `ctl-c` to stop it.

```js
cd ~
$ sudo npm install pm2@latest -g
```

## Run todo-server using `pm2`
```js
$ pm2 start app/server
```

Output
```js
                        -------------

__/\\\\\\\\\\\\\____/\\\\____________/\\\\____/\\\\\\\\\_____
 _\/\\\/////////\\\_\/\\\\\\________/\\\\\\__/\\\///////\\\___
  _\/\\\_______\/\\\_\/\\\//\\\____/\\\//\\\_\///______\//\\\__
   _\/\\\\\\\\\\\\\/__\/\\\\///\\\/\\\/_\/\\\___________/\\\/___
    _\/\\\/////////____\/\\\__\///\\\/___\/\\\________/\\\//_____
     _\/\\\_____________\/\\\____\///_____\/\\\_____/\\\//________
      _\/\\\_____________\/\\\_____________\/\\\___/\\\/___________
       _\/\\\_____________\/\\\_____________\/\\\__/\\\\\\\\\\\\\\\_
        _\///______________\///______________\///__\///////////////__


                          Runtime Edition

        PM2 is a Production Process Manager for Node.js applications
                     with a built-in Load Balancer.

                Start and Daemonize any application:
                $ pm2 start app.js

                Load Balance 4 instances of api.js:
                $ pm2 start api.js -i 4

                Monitor in production:
                $ pm2 monitor

                Make pm2 auto-boot at server restart:
                $ pm2 startup

                To go further checkout:
                http://pm2.io/


                        -------------

[PM2] Spawning PM2 daemon with pm2_home=/home/doadmin/.pm2
[PM2] PM2 Successfully daemonized
[PM2] Starting /home/doadmin/todo-server/server in fork_mode (1 instance)
[PM2] Done.
┌──────────┬────┬─────────┬──────┬───────┬────────┬─────────┬────────┬─────┬───────────┬─────────┬──────────┐
│ App name │ id │ version │ mode │ pid   │ status │ restart │ uptime │ cpu │ mem       │ user    │ watching │
├──────────┼────┼─────────┼──────┼───────┼────────┼─────────┼────────┼─────┼───────────┼─────────┼──────────┤
│ server   │ 0  │ 1.0.0   │ fork │ 16082 │ online │ 0       │ 0s     │ 0%  │ 25.0 MB   │ doadmin │ disabled │
└──────────┴────┴─────────┴──────┴───────┴────────┴─────────┴────────┴─────┴───────────┴─────────┴──────────┘
 Use `pm2 show <id|name>` to get more details about an app
```


> TODO: the below does what?
> It 'Generate Start Script'

```js
pm2 startup systemd
```

output
```console
[PM2] Init System found: systemd
[PM2] To setup the Startup Script, copy/paste the following command:
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u doadmin --hp /home/doadmin
```


Run the command from the output above, which will result in output similiar to this:

```console
[PM2] Init System found: systemd
Platform systemd
Template
[Unit]
Description=PM2 process manager
Documentation=https://pm2.keymetrics.io/
After=network.target

[Service]
Type=forking
User=doadmin
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
Environment=PM2_HOME=/home/doadmin/.pm2
PIDFile=/home/doadmin/.pm2/pm2.pid
Restart=on-failure

ExecStart=/usr/lib/node_modules/pm2/bin/pm2 resurrect
ExecReload=/usr/lib/node_modules/pm2/bin/pm2 reload all
ExecStop=/usr/lib/node_modules/pm2/bin/pm2 kill

[Install]
WantedBy=multi-user.target

Target path
/etc/systemd/system/pm2-doadmin.service
Command list
[ 'systemctl enable pm2-doadmin' ]
[PM2] Writing init configuration in /etc/systemd/system/pm2-doadmin.service
[PM2] Making script booting at startup...
[PM2] [-] Executing: systemctl enable pm2-doadmin...
Created symlink /etc/systemd/system/multi-user.target.wants/pm2-doadmin.service → /etc/systemd/system/pm2-doadmin.service.
[PM2] [v] Command successfully executed.
+---------------------------------------+
[PM2] Freeze a process list on reboot via:
$ pm2 save

[PM2] Remove init script via:
$ pm2 unstartup systemd

```

Now use `curl` to test the server again
```js
$ curl http://localhost:3030
```
Once again you should see
```js
Response from todo-server
```

We want PM2 to load and start todo-server whenever the Ubuntu server boots. Use the below command to make that happen
```js
pm2 startup systemmd
```
Output
```js
[PM2] Init System found: systemd
-----------------------------------------------------------
 PM2 detected systemd but you precised systemmd
 Please verify that your choice is indeed your init system
 If you arent sure, just run : pm2 startup
-----------------------------------------------------------
[PM2] To setup the Startup Script, copy/paste the following command:
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemmd -u doadmin --hp /home/doadmin
```

Run the command at the end of the output
```js
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemmd -u doadmin --hp /home/doadmin
```

> TODO: I messed-up here. Think I forgot to run the above command and ran pm2 save and tried to use systemctl (below). PM2 instructued me to use the line
```js
sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u doadmin --hp /home/doadmin
```
> Which is the same as above
> Here is the output
```js
[PM2] Init System found: systemd
Platform systemd
Template
[Unit]
Description=PM2 process manager
Documentation=https://pm2.keymetrics.io/
After=network.target

[Service]
Type=forking
User=doadmin
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity
Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
Environment=PM2_HOME=/home/doadmin/.pm2
PIDFile=/home/doadmin/.pm2/pm2.pid
Restart=on-failure

ExecStart=/usr/lib/node_modules/pm2/bin/pm2 resurrect
ExecReload=/usr/lib/node_modules/pm2/bin/pm2 reload all
ExecStop=/usr/lib/node_modules/pm2/bin/pm2 kill

[Install]
WantedBy=multi-user.target

Target path
/etc/systemd/system/pm2-doadmin.service
Command list
[ 'systemctl enable pm2-doadmin' ]
[PM2] Writing init configuration in /etc/systemd/system/pm2-doadmin.service
[PM2] Making script booting at startup...
[PM2] [-] Executing: systemctl enable pm2-doadmin...
Created symlink /etc/systemd/system/multi-user.target.wants/pm2-doadmin.service → /etc/systemd/system/pm2-doadmin.service.
[PM2] [v] Command successfully executed.
+---------------------------------------+
[PM2] Freeze a process list on reboot via:
$ pm2 save

[PM2] Remove init script via:
$ pm2 unstartup systemd

```

> Running via systemctl still didn't work. Rebooting solved the problem.






Tell PM2 to save the current list of proceses to manage
```js
$ pm2 save
```

Next uses `systemctl` to start PM2
Stop PM2 if it is already running
```js
$ pm2 stop server
```
Start with `systemctl`
```js
sudo systemctl start pm2-doadmin
```

> You can learn more about PM2 at the [PM2 website](https://pm2.io/). Note that PM2 has 3 products. We are using [PM2 Runtime](https://pm2.io/doc/en/runtime/overview/) which is also the link to the relevant documentation.
> For more essential PM2 commands see [Quick Start](https://pm2.keymetrics.io/docs/usage/quick-start/)

TODO: this link was better but is now a 404. Where did it go? [PM2 Runtime Command Sheatsheet](https://pm2.io/doc/en/runtime/features/commands-cheatsheet/)
