> TODO: seems I have not been using absolute references/imports. Need to implement this from very start.

> TODO: seems it would be a good idea to put the config code in 'wrapping-calls-to-mongodb'

We are going to do this and that

## Add packages

```console
$ npm i mongodb morgan ramda
$ npm i -D nodemon chai mocha supertest @babel/register
```

> TODO:Question: Is chai-http needed?



## Configuration

> TODO: If I do put config into wrapping-calls-to-mongodb, this part will also be a copy paste

```console
$ mkdir config
$ touch config/index.js
```

Don't put config/index.js in git
```
// .gitignore
config/index.js
```

```js
// config/index.js

const mongoUrl = () => {
  const env = process.env.NODE_ENV
  if (env === 'test') {
    return 'mongodb://localhost:27017'
  }
  return 'mongodb+srv://todo-db-admin:D92dARWONO0t16uF@todo-cluster0-ilc7v.mongodb.net/test?retryWrites=true'
}

const dbName = () => {
  const env = process.env.NODE_ENV
  if (env === 'test') {
    return 'todo-test'
  } else if (env === 'dev') {
    return 'todo-dev'
  }
  return 'todo-prod'
}

const apiRoot = ()  => {
  const env = process.env.NODE_ENV
  if (env === 'prod') {
    return ''
  }
  return 'https://api.klequis-todo.tk'
}

export default {
  mongoUrl: mongoUrl(),
  dbName: dbName(),
  apiRoot: apiRoot(),
  port: 3030
};

```

## `db/dbFunctions.js` Changes
Move the /db directory from 'wrapping-calls-to-mongodb' to the current project
`dbFunctions.js` is using hard coded values for configuration. Change it to make use of /config.

```js
import config from '../config'

...
// from
client = await MongoClient.connect(mongoUrl, { useNewUrlParser: true })
// to
client = await MongoClient.connect(config.mongoUrl, { useNewUrlParser: true })

...

// from
return { db: client.db(dbName) }
// to
return { db: client.db(config.dbName) }

...
```

## Copy the `test/` Directory

Move the /test directory from 'wrapping-calls-to-mongodb' to the current project

Add test and test-watch scripts to package.json, (copied from wrapping-calls-to-mongodb)
```json
"test": "mocha --require @babel/register",
"test-watch": "export WATCH='watch' && nodemon --exec 'npm test'",
```

> TODO: I don't understand `export WATCH='watch'`


## Run Tests
Start MongoDB if it isn't already running
```console
$ sudo service mongod start
```

Run the tests
```console
npm run test-watch
```

Hopefully, all of the tests past. If not, debug them before moving on.


## `server/` Changes

Add
```js
import morgan from 'morgan'
import todo from '../routes/todo-route'
import config from '../config'
```

Delete
```js
const port = 3030
```

Delete
```js
app.get('/', (req, res) => {
    res.status(200).send({ data: 'hello', error: '' })
})
```

Add
```js
app.use(morgan('dev'))

app.use('/api/todo', todo)
app.get('/api', (req, res) => {
  console.error('Invalid endpoint!')
  res.send('Invalid endpoint!')
})


// Change `port` to `config.port`
app.listen(config.port, () => {
  console.log(`Events API server is listening on port ${config.port}`)
})

// ?
// export default app
```

## Routes

> TODO: add `update` route

> TODO: currently findOneAndUpdate & objectIdFromHexString are not needed. findOneAndUpdate will be but I'm not sure about objectIdFromHexString

Create a directory named `routes`
Create a file named `todo-route.js`
Make the routes as below

> TODO: explain routes and how to make them step by step

```js
import express from 'express'
import { find, findById, insertOne, findOneAndDelete, findOneAndUpdate, objectIdFromHexString } from '../db'
import { red, yellow } from '../logger'

const router = express.Router()

/*
    - assumes only { title: string } is sent
    - { completed: false } will be added to all new todos
 */

router.post('/', async (req, res) => {
  try {
    const td1 = req.body
    // yellow('post', td1)
    const td2 = {
      title: td1.title,
      completed: false,
    }
    const inserted = await insertOne(
      'todos',
      td2
    )
    res.send(inserted)
  } catch (e) {
    red('error', e)
    res.status(400).send(e)
  }
})

router.get('/', async (req, res) => {
  try {
    const todos = await find('todos')
    res.send(todos)
  } catch (e) {
    res.status(400).send(e)
  }
})

router.get('/:id', async (req, res) => {
  const id = req.params.id
  try {
    const todos = await findById('todos', id)
    res.send(todos)
  } catch (e) {
    res.status(400).send(e)
  }
})

router.delete('/:id', async (req, res) => {
  const id = req.params.id
  try {
    let todo = await findOneAndDelete('todos', id)
    if (!todo) {
      return res.status(404).send()
    }
    res.send(todo)
  } catch (e) {
    res.status(400).send()
  }
})

export default router

```
