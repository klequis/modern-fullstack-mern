# Configuration

You could use `dot-env` for environment variables. However, PM2 uses a file named ecosystem.config.js. Having the environment variables in a JavaScript file allows for the use of variables and therefore less duplication. I also find it more organized and readable. As a result, PM2 is injecting the variables when the Express server is running on the remote server (i.e., DigitalOcean) and I wrote some code to make them available when on my local machine.

## `ecosystem.config.js`

Below is a shortened version of `ecosystem.config.js`. It allows you to have multiple apps in the `apps` property which is an array. We will only have one app, so an array of one. Here are a few things to take note of

App-wide variables
- name: will be the name of the app in the PM2 process list
- script: the path to the file that will be executed for the app

Environment specific variables
- Show below are two environments, 'production' and 'testLocal'
- If PM2 finds an environment name 'env', it will be the default. I choose to be more specific and not to use this.
- Note how the use of variables is reducing repitition and the possibility of typos/inconsistencies.
- Then environment to run is passed in the `pm2` command line as will be shown later.

```js

const mongoUrlRemote = 'mongodb+srv://todo-db-admin:D92dARWONO0t16uF@todo-cluster0-ilc7v.mongodb.net/test?retryWrites=true'

const mongoUrlLocal = 'mongodb://localhost:27017'

...
const dbNameTest = 'todo-test'
const dbNameProd = 'todo-prod'

const apiRootLocal = ''
const apiRootRemote = 'https://klequis-todo.tk'

const port = 3030

module.exports = {
  apps: [{
    name: 'todo-server',
    script: 'app/server/index.js',

    production: {
      NODE_ENV: 'production',
      MONGODB_URL: mongoUrlRemote,
      DB_NAME: dbNameProd,
      API_ROOT: apiRootRemote,
      PORT: 3030,
    },
    testLocal: {
      NODE_ENV: "testLocal",
      MONGODB_URL: mongoUrlLocal,
      DB_NAME: dbNameTest,
      API_ROOT: apiRootLocal,
      PORT: 3030,
    },

    ...

  }]
}
```


> IMPORTANT: If you make changes to your ecosystem.config.js you need to restart PM2 with the `--update-env` flag:
```js
pm2 restart ecosystem.config.js --update-env
```
> To switch environments
```js
pm2 restart ecosystem.config.js --env production --update-env
```

## Code for Reading Config

As noted above, we don't need to do anything when running on the remote server as that is taken care of by PM2. However, when running locally, either in dev or test, we need to read in the variables from `ecosystem.config.js` and add them to the processes environment.

The following functionality is needed:
- Ability to read variables from `ecosystem.config.js`
- A function to call from other parts of our code to initialize the environment
- Get & add variables to the process
- The ability to ignore parts of `ecosystem.config.js`

### Ignoring Parts of `ecosystem.config.js`

This will be implemented using an array to specify what properties to ignore and a function to check if a given property should be ignored.

```js
const _ignoreProps = ['name', 'script']

const shouldIgnore = (key) => {
  return _ignoreProps.includes(key)
}
```
