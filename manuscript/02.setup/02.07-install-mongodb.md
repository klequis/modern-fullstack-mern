

## 02.07 MongoDB Local Install
The production version of our app will use [MongoDB](https://mongodb.com) hosted on [MongoDB Atlas](https://www.mongodb.com/cloud/atlas). However, for development it is easier to work with MongoDB locally. Install MongoDB on your local machine using these instructions: [Install MongoDB Community Edition](https://docs.mongodb.com/manual/administration/install-community/).


> TODO: mongodb vs mongod: There is some confusion around the commands ...
```console
sudo systemctl ? mongodb

vs

sudo systemctl ? mongod
```
... where '?' can be stop, start, enable or disable.
The difference in the commands is 'mongodb' ending with the letter 'b' vs 'mongod' with no 'b' on the end. I see this in a lot of documentation. On my machine I need to use 'mongod'.
> Check on the VM if it is mongod or mongodb





> TODO: How to incorporate this material?

## Definitions


- **Resource:** A resource can be a database, collection, set of collections or a cluster.

- **Privileges:** A privilege consists of a specified resource and the actions permitted on it.

- **Action:** An action specifies the operation allowed on the resource. For example 'find', 'create' or 'insert'.

- **Role:** A role grants privileges to perform specific actions on a resource. A role can contain one or more privilege. It can also contain other roles, in which case granting the role to a user applies the privileges in the contained role.
  - **[Built-In Roles](https://docs.mongodb.com/manual/reference/built-in-roles/):** Built-in roles are roles that come with MongoDB by default. A complete list of built-in roles can be found at .
  - [**User-Defined roles](https://docs.mongodb.com/manual/core/security-user-defined-roles/):** User-defined roles are roles that are created by a MongoDB user. You use them to customize privileges according to your needs.

## [Role-Based Access Control](https://docs.mongodb.com/manual/core/authorization/#role-based-access-control)

Initially after installation, access control is not enabled. Once you enable it users must authenticate themselves.

## [Authentication Database](https://docs.mongodb.com/manual/core/security-users/#user-authentication-database)

- So you create a given user in a given database and that becomes the authentication for the user. However, a user's privileges are not limited to that database. You can assign it roles in other databases as well.


## [Certificate Authority](https://docs.mongodb.com/manual/core/security-x.509/#certificate-authority)

> For production use, your MongoDB deployment should use valid certificates generated and signed by a single certificate authority. You or your organization can generate and maintain an independent certificate authority, or use certificates generated by a third-party TLS/SSL vendor. Obtaining and managing certificates is beyond the scope of this documentation.



## Illustrative Info
- You can see users in roles using Robo3T. Roles are in system.roles and users in system.users


---

- [Database Commands](https://docs.mongodb.com/manual/reference/command/)
  - [Role Management Commands](https://docs.mongodb.com/manual/reference/command/nav-role-management/)
  - [createUser](https://docs.mongodb.com/manual/reference/command/#user-management-commands)



---

Begin content

---


# Installing 4.x
-----------------

https://docs.mongodb.com/manual/tutorial/install-mongodb-on-ubuntu/


```console

sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 9DA31620334BD75D9DCB49F368818C72E52529D4

echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list

sudo apt-get update

sudo apt-get install -y mongodb-org

sudo systemctl enable mongod
sudo systemctl start mongod

```


## Create superuser
```console
mongo
use admin

db.createUser(
  {
    user: "superuser",
    pwd: "karl",
    roles: [ "root" ]
  }
)
```

## Enable Authenticaton

```console

ctrl+c

sudo nano /lib/systemd/system/mongod.service


```

# add --auth
ExecStart=/usr/bin/mongod --auth --config /etc/mongod.conf

ctrl+o
enter
ctrl+x

sudo systemctl daemon-reload

sudo service mongod restart


```


## Verify Authentication

```js

mongo
```

Output - no longer warning about authentication
```js
MongoDB shell version v4.0.10
connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb
Implicit session: session { "id" : UUID("f0f33c53-812d-4db6-b4d2-a7eb30aa7048") }
MongoDB server version: 4.0.10

```


- Try ...
```
db.getUsers()
```
... and get 'not authorized' message
```
2019-06-01T11:35:26.549-0700 E QUERY    [thread1] Error: not authorized on test to execute command { usersInfo: 1.0, $db: "test" } :
_getErrorWithCode@src/mongo/shell/utils.js:25:13
DB.prototype.getUsers@src/mongo/shell/db.js:1686:1
@(shell):1:1

```

## Create testUser

Login as superuser
```js
ctrl+c
mongo -u superuser -p --authenticationDatabase admin
```


```js
use todo-test
db.createUser(
  {
    user: "testUser",
    pwd: "karl",
    roles: [ { role: "readWrite", db: "todo-test" } ]
  }
)
```

```js
use todo-dev
db.createUser(
  {
    user: "devUser",
    pwd: "karl",
    roles: [ { role: "readWrite", db: "todo-dev" } ]
  }
)
```


Exit & login as testUser

```js
ctrl+c
mongo -u testUser -p --authenticationDatabase todo-test
```



## Test testUser
```js
use todo-test

db.todos.insertOne({ title: 'todo1', completed: false })
{
	"acknowledged" : true,
	"insertedId" : ObjectId("5cf316024766652dcde6f7b5")
}
```

Output
```js
 {
... "acknowledged" : true,
... "insertedId" : ObjectId("5cf316024766652dcde6f7b5")
... }
```


```js

db.todos.find()
{ "_id" : ObjectId("5cf316024766652dcde6f7b5"), "title" : "todo1", "completed" : false }

```
Output
```js
{
... "acknowledged" : true,
... "insertedId" : ObjectId("5cf316024766652dcde6f7b5")
... }
```

## Commands

```
sudo systemctl start mongodb
sudo systemctl stop mongodb
sudo systemctl restart mongodb
sudo systemctl status mongodb
sudo systemctl enable mongodb // don't start automatically
sudo systemctl disable mongodb // don't start automatically
```


## Test App
1. clone app
```js
git clone https://github.com/klequis/wrapping-calls-to-mongodb.git
```
2. Open in vs code
```js
cd wrapping-calls-to-mongodb
code .
```
__index.js__
```js
return 'mongodb://localhost:27017'
```
to
```js
return 'mongodb://testUser:password@localhost:27017'
```

```js
npm i
npm run test
```
All tests should pass
