# Using Nginx as a Reverse Proxy

## Ref
https://www.digitalocean.com/community/tutorials/how-to-set-up-a-node-js-application-for-production-on-ubuntu-16-04

Currently todo-server can only be accessed from the server it is running on. To make todo-server accessible to the client application will will setup Nginx as a reverse proxy server.

> TODO: What is a reverse proxy

Edit the server block for api.todo-server.tk
```
sudo nano /etc/nginx/sites-available/api.klequis-todo.tk
```

Replace the existing `location` block with the following

> CAUTION: Use spaces not tabs. Nginx will consider tabs a syntax error

```
proxy_pass http://localhost:3030;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection 'upgrade';
proxy_set_header Host $host;
proxy_cache_bypass $http_upgrade;
```

> TODO: what does the above do?

The complete file should look like this

> TODO: Potentially, parts of the file above 'location' are not needed. Explore to find out.

```
server {

root /var/www/api.klequis-todo.tk/html;
        index index.html index.htm index.nginx-debian.html;

        server_name api.klequis-todo.tk www.api.klequis-todo.tk;

        location / {
            proxy_pass http://localhost:3030;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/api.klequis-todo.tk/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/api.klequis-todo.tk/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

}
server {
    if ($host = api.klequis-todo.tk) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80;
        listen [::]:80;

        server_name api.klequis-todo.tk www.api.klequis-todo.tk;
    return 404; # managed by Certbot


}
```

Check the syntax of your edits.

```
sudo nginx -t
```

Reply:

```
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
```

Restart Nginx.

```
sudo systemctl restart nginx
```

## Test in Browser

If the Express application is not running, start it before proceeding. To do so:

```
node ~/app/server
```
Now go to a browser and enter the address for your server

Make sure your Express Application is running.

```
https://api.klequis-todo.tk
```

> NOTE: I have done this process many times and it dosn't always work on the first try. If you are still getting the HTML page instead of the response from the Express server try restarting Nginx again and/or clearing your browser's cache.

The page should show
> TODO: picture 'response from todo-server'


Wow, that was a lot of work but it feels good to successfully have a server up and running. We can now focus on building out the actual server.
