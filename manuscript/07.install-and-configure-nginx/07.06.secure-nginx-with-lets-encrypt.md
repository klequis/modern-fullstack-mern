# Securing Nginx with Let's Encrypt

## Ref

- https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-ubuntu-18-04

## Install Certbot

Add repository (Install Certbot)

```
sudo add-apt-repository ppa:certbot/certbot
```

Install

```
sudo apt install python-certbot-nginx
```

## Confirm Configuration

- this section inspects the serer block configuration

```
sudo nano /etc/nginx/sites-available/api.klequis-todo.tk
```


## Allow HTTPS

Add Nginx Full

```
sudo ufw allow 'Nginx Full'
```

Reply:

```
Rule added
Rule added (v6)
```

Remove Ngnix HTTP

```
sudo ufw delete allow 'Nginx HTTP'
```

Reply:

```
Rule deleted
Rule deleted (v6)
```

Check status.

```
sudo ufw status
```

Reply:

```
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere                  
Nginx Full                 ALLOW       Anywhere                  
OpenSSH (v6)               ALLOW       Anywhere (v6)             
Nginx Full (v6)            ALLOW       Anywhere (v6)
```

> TODO: above says HTTP was removed, but the status 'Nginx Full' seems to mean all/both. Read ufw doc to confirm. old: TODO: This is currently allowing HTTP & HTTPS traffice in. Once working, try removing HTTP and allowing HTTPS only.

## Obtain an SSL Certificate (Get SSL Certificate)

```
sudo certbot --nginx -d api.klequis-todo.tk
```

Enter your email

Type 'A' and press 'Enter' to accept the terms of service.

Type 'Y' or 'N' and press 'enter' when asked to share you email with the Electronic Frontier Foundation.

Choices are presented. We want all traffic redirected to HTTPS so choose #2 'Redirect'

## Test in Browser

Go back to the browser where you had api.klequis-todo.tk and refresh. You should see the URL change to https://api.klequis-todo.tk and the browsers security indicator should be positive.

## Test configuration at SSLLabs

You can test your SSL configuration at [SSL Labs](https://www.ssllabs.com/ssltest/index.html).

## Test the Auto-renewal process

```
sudo certbot renew --dry-run
```
